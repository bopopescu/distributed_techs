## 高并发处理的思路及手段 

![](E:\GIT\distributed_techs\imgs\java并发编程相关图例\3.jpg)

### 1. 高并发场景之扩容

占用内存大小取决于工作内存里变量的多少，单个线程占用内存通常不会很大，但随着并发线程不断增加占用的内存也随之增加，最简答的扩容方法是增加系统内存(垂直扩容)，这样应用能够分配更多的内存来支撑并发的压力。复杂一点可能会考虑增加一台服务器分担一些压力(水平扩容)。

**垂直扩容**

在垂直扩展模型中，想要增加系统负荷就意味着要在系统现有的部件上下工夫，即通过提高系统部件的能力来实现。通过提高某个部件的性能（或速度）来提高负载能力的。（如数据库增加缓存处理，增加服务器CPU性能等） 。

**例子：**我们假设有3辆卡车，每辆车一次可以运25根木材，计算花费1小时的情况下可以运送到指定地点等待处理的木材数量。通过这些数字我们可以算出我们系统最大的负荷量：
$$
3辆卡车 * 25根木材 * 1小时=75根木材／小时
$$
如果我们选择垂直扩展模型，那么我们将怎么做来使我们每小时可以处理150根木材？我们需要至少做以下两件事中的一件：

1. 使每辆卡车的运输量增加一倍（50棵树每小时）：3辆卡车 * 50棵树 * 1小时 = 150棵树／每小时。
2. 使每辆卡车的运输时间减半（每辆卡车30分钟）：3辆卡车 * 25棵树 * 30分钟 = 150棵树／每小时。

我们没有增加系统的成员数，但是我们通过增加系统成员的生产效率来获得期望的负荷量。

**水平扩容**

在水平扩展模型中，我们不是通过增加单个系统成员的负荷而是简单的通过增加更多的系统成员来实现。 通过增加更多的系统成员（性能或速度一样）来提高负载能力的（如服务器集群）。

**例子：**在以上运送木材的例子中，通过增加卡车的数量来运送木材，因此当我们需要将负荷从75棵树每小时增加到150棵树每小时，那么只需要增加3辆卡车。

为什么数据库是最边缘的？因为数据库通常是共享资源，是几乎所有请求最终的连接点。

- **读操作扩展**

  如 果你的系统读操作非常多，那么通过关系型数据库如mysql或者PostgreSql来垂直扩展数据存储是一个不错的选择。结合你的关系型数据库通过使用 memcached或者CDN来构建一个健壮的缓存系统，那么你的系统将非常容易扩展。在这种模式中，如果数据库超负荷运行，那么将更多的数据放入缓存中来缓解系统的读压力。当没有更多的数据往缓存中放时，可以更换更快的数据存储硬件或者买更多核的处理器来获取更多的运行通道。摩尔定律使通过这种方法来垂直扩展变得和购买更好的硬件一样简单。

- **写操作扩展**

  如 果你的系统写操作非常多，那么你可能更希望考虑使用可水平扩展的数据存储方式，比如Riak，Cassandra或者HBase。和大多数关系型数据管理 系统不同，这种数据存储随着增长增加更多的节点。由于你的系统大部分时间是在写入，所以缓存曾并不能像在读操作比较频繁的系统中起到那么大作用。很多写频 繁的系统一开始使用垂直扩展的方式，但是很快发现并不能根本解决问题。为什么？因为硬盘数和处理器数在某一点达到平衡，在这个边界上再增加一个处理器或者 一个硬盘都会是每秒钟的I/O操作数成指数性增长。相反，如果对写频繁的系统采取水平扩展策略，那么你将达到一个拐点，在这个拐点之后如果在增加一个节点都远比使用更多的硬盘来的实惠。

**扩容引入的开销**

每种扩展策略下预想不到的开销。采用垂直扩展的系统将开销凡在单独的组件上。当我们去提升系统负荷时，这些单独的组件需要在管理上花费更多。拿我们运送木材的例子来说，如果需要使每辆卡车的货运量翻倍，那么我们需要更宽、更长、或者更高的车厢。也许有的路因为桥的高度对车辆高度有要求， 或者基于巷子宽度车宽不能太大，又或者由于机动车安全驾驶要求车厢不能太长。这里的限制就是对单个卡车做垂直扩展做的什么程度。同样的概念延伸到服务器垂直扩展：更多的处理器要求更多的空间，进而要求更多的服务器存储架。

采用水平扩展的系统将额外的开销放在系统中连接起来的共享组件上。当我们去提升系统负荷时，共享的开销和新增加的成员之间的协调性有关。在我们运送木材的例子中，当我们在路上增加更多卡车时，那么路就是共享资源也就 成了约束条件。这条路上适合同时跑多少量卡车？我们是否有足够的安全缓冲区使得所有的车可以同时装运木材？如果再来看我们水平扩展的数据库系统，那么经常 被忽略的开销就是服务器同时连接时的网络开销(译者注：网络为各个系统的共享资源)。当你为系统增加更多的节点时，共享资源的负荷也就越来越重，通常呈非线性改变。

### 2. 高并发场景之缓存















